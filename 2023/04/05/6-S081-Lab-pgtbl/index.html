<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>MIT 6.S081 Lab pgtbl | Huayi</title><meta name="author" content="Huayi"><meta name="copyright" content="Huayi"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Compulsory exercises Preparation   reading    To start the lab, switch to the pgtbl branch:   123git fetchgit checkout pgtblmake clean">
<meta property="og:type" content="article">
<meta property="og:title" content="MIT 6.S081 Lab pgtbl">
<meta property="og:url" content="http://blog.huaeryi.top/2023/04/05/6-S081-Lab-pgtbl/index.html">
<meta property="og:site_name" content="Huayi">
<meta property="og:description" content="Compulsory exercises Preparation   reading    To start the lab, switch to the pgtbl branch:   123git fetchgit checkout pgtblmake clean">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://blog.huaeryi.top/image/sheep.png">
<meta property="article:published_time" content="2023-04-05T13:16:13.000Z">
<meta property="article:modified_time" content="2023-04-23T06:31:09.488Z">
<meta property="article:author" content="Huayi">
<meta property="article:tag" content="C">
<meta property="article:tag" content="OS">
<meta property="article:tag" content="RISC-V">
<meta property="article:tag" content="GNU Make">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blog.huaeryi.top/image/sheep.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "MIT 6.S081 Lab pgtbl",
  "url": "http://blog.huaeryi.top/2023/04/05/6-S081-Lab-pgtbl/",
  "image": "http://blog.huaeryi.top/image/sheep.png",
  "datePublished": "2023-04-05T13:16:13.000Z",
  "dateModified": "2023-04-23T06:31:09.488Z",
  "author": [
    {
      "@type": "Person",
      "name": "Huayi",
      "url": "http://blog.huaeryi.top"
    }
  ]
}</script><link rel="shortcut icon" href="/image/sheep.png"><link rel="canonical" href="http://blog.huaeryi.top/2023/04/05/6-S081-Lab-pgtbl/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'MIT 6.S081 Lab pgtbl',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 6.1.0"><link rel="alternate" href="/atom.xml" title="Huayi" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/image/sheep.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">93</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">38</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">18</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/image/background.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="/image/sheep.png" alt="Logo"><span class="site-name">Huayi</span></a><a class="nav-page-title" href="/"><span class="site-name">MIT 6.S081 Lab pgtbl</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">MIT 6.S081 Lab pgtbl</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-04-05T13:16:13.000Z" title="发表于 2023-04-05 21:16:13">2023-04-05</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-04-23T06:31:09.488Z" title="更新于 2023-04-23 14:31:09">2023-04-23</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">620</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>3分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h3 id="Compulsory-exercises-2">Compulsory exercises</h3>
<h4 id="Preparation-2">Preparation</h4>
<ul class="lvl-0">
<li class="lvl-2">
<p>reading<br>
<img src="/2023/04/05/6-S081-Lab-pgtbl/pre.png" alt="preparation"></p>
</li>
<li class="lvl-2">
<p>To start the lab, switch to the pgtbl branch:</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git fetch</span><br><span class="line">git checkout pgtbl</span><br><span class="line">make clean</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<h4 id="Speed-up-system-calls-easy">Speed up system calls (easy)</h4>
<ul class="lvl-0">
<li class="lvl-2">
<p>getpid()作为系统调用，每次调用时需要跳入内核并跳出，为加速pid的获取，ugetpid()函数可以通过分配虚拟地址将pid存入其中，从而实现不跳转不trap获取pid</p>
</li>
<li class="lvl-2">
<p>修改内核函数实现ugetpid()<br>
<img src="/2023/04/05/6-S081-Lab-pgtbl/speed.png" alt="speed"></p>
</li>
<li class="lvl-2">
<p>map one <mark>read-only</mark> page at USYSCALL in proc_pagetable()</p>
</li>
</ul>
<figure class="highlight c"><figcaption><span>proc.c proc_pagetable()</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(mappages(pagetable, USYSCALL, PGSIZE,</span><br><span class="line">            (uint64)(p-&gt;usyscall), PTE_R | PTE_U) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">  uvmfree(pagetable, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul class="lvl-0">
<li class="lvl-2">
<p>allocate and initialize the page in allocproc()</p>
</li>
</ul>
<figure class="highlight c"><figcaption><span>proc.c allocproc()</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Allocate a usyscall page before creating a new pagetable</span></span><br><span class="line"><span class="keyword">if</span>((p-&gt;usyscall = (<span class="keyword">struct</span> usyscall *)kalloc()) == <span class="number">0</span>)&#123;</span><br><span class="line">  freeproc(p);</span><br><span class="line">  release(&amp;p-&gt;lock);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul class="lvl-0">
<li class="lvl-2">
<p>free the page in freeproc()</p>
</li>
</ul>
<figure class="highlight c"><figcaption><span>proc.c freeproc()</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(p-&gt;usyscall) &#123;</span><br><span class="line">  kfree((<span class="type">void</span>*)p-&gt;usyscall);</span><br><span class="line">  p-&gt;usyscall = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul class="lvl-0">
<li class="lvl-2">
<p>umap USYSCALL in proc_freepagetable()</p>
</li>
</ul>
<figure class="highlight c"><figcaption><span>proc.c proc_freepagetable()</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uvmunmap(pagetable, USYSCALL, <span class="number">1</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<h4 id="Print-a-page-table-easy">Print a page table (easy)</h4>
<ul class="lvl-0">
<li class="lvl-2">
<p>RISC-V架构中的三级页表需要通过递归打印</p>
</li>
<li class="lvl-2">
<p>添加内核函数vmprint()<br>
<img src="/2023/04/05/6-S081-Lab-pgtbl/vmprint.png" alt="vmprint"></p>
</li>
<li class="lvl-2">
<p>prototype for vmprint in defs.h</p>
</li>
</ul>
<figure class="highlight c"><figcaption><span>defs.h //vm.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span>            <span class="title function_">vmprint</span><span class="params">(<span class="type">pagetable_t</span>)</span>;</span><br></pre></td></tr></table></figure>
<ul class="lvl-0">
<li class="lvl-2">
<p>put vmprint() in vm.c</p>
</li>
</ul>
<figure class="highlight c"><figcaption><span>vm.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// help function</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">vmprinthelp</span><span class="params">(<span class="type">pagetable_t</span> pagetable, <span class="type">int</span> level)</span> &#123;</span><br><span class="line">    <span class="type">char</span> *dot;</span><br><span class="line">    <span class="keyword">if</span> (level == <span class="number">2</span>) dot = <span class="string">&quot;..&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (level == <span class="number">1</span>) dot = <span class="string">&quot;.. ..&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (level == <span class="number">0</span>) dot = <span class="string">&quot;.. .. ..&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">512</span>; i++) &#123;</span><br><span class="line">        <span class="type">pte_t</span> pte = pagetable[i];</span><br><span class="line">        <span class="keyword">if</span> (pte &amp; PTE_V) &#123;</span><br><span class="line">            uint64 child = PTE2PA(pte);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s%d: pte %p pa %p\n&quot;</span>, dot, i, pte, child);</span><br><span class="line">            <span class="keyword">if</span> (level != <span class="number">0</span>) &#123;</span><br><span class="line">               vmprinthelp((<span class="type">pagetable_t</span>)child, level - <span class="number">1</span>);               </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">vmprint</span><span class="params">(<span class="type">pagetable_t</span> pagetable)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;page table %p\n&quot;</span>, pagetable);</span><br><span class="line">    vmprinthelp(pagetable, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Detecting-which-pages-have-been-accessed-hard">Detecting which pages have been accessed (hard)</h4>
<ul class="lvl-0">
<li class="lvl-2">
<p>探测页表中的页是否被访问过</p>
</li>
<li class="lvl-2">
<p>添加pgaccess系统调用<br>
<img src="/2023/04/05/6-S081-Lab-pgtbl/pgaccess.png" alt="pgaccess"></p>
</li>
<li class="lvl-2">
<p>implementing sys_pgaccess() sysproc.c</p>
</li>
</ul>
<figure class="highlight c"><figcaption><span>sysproc.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> LAB_PGTBL</span></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">sys_pgaccess</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// lab pgtbl: your code here.</span></span><br><span class="line">  uint64 firstpte;</span><br><span class="line">  <span class="type">int</span> num;</span><br><span class="line">  uint64 buf;</span><br><span class="line">  <span class="keyword">if</span> (argaddr(<span class="number">0</span>, &amp;firstpte) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">if</span> (argint(<span class="number">1</span>, &amp;num) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">if</span> (argaddr(<span class="number">2</span>, &amp;buf) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="type">pagetable_t</span> pagetable = myproc()-&gt;pagetable;</span><br><span class="line">  pgaccess(pagetable, firstpte, num, buf);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<ul class="lvl-0">
<li class="lvl-2">
<p>define PTE_A, the access bit, in riscv.h 参考下图PTE_A的位置<br>
<img src="/2023/04/05/6-S081-Lab-pgtbl/RISCVPT.png" alt></p>
</li>
</ul>
<figure class="highlight c"><figcaption><span>riscv.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_A (1L <span class="string">&lt;&lt; 6) // 1 -&gt;</span> Accessed</span></span><br></pre></td></tr></table></figure>
<ul class="lvl-0">
<li class="lvl-2">
<p>add pgaccess() in vm.c</p>
<ul class="lvl-2">
<li class="lvl-4">注意第一个page对应mask最低有效位</li>
<li class="lvl-4">注意探测一个带有PTE_A的page过后要消除PTE_A</li>
</ul>
</li>
</ul>
<figure class="highlight c"><figcaption><span>vm.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">uint64</span><br><span class="line"><span class="title function_">pgaccess</span><span class="params">(<span class="type">pagetable_t</span> pagetable, uint64 firstpte, <span class="type">int</span> num, uint64 buf)</span> &#123;</span><br><span class="line">  uint64 mask = <span class="number">0</span>;</span><br><span class="line">  uint64 limit = <span class="number">64</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (uint64 i = <span class="number">0</span>; i &lt; num &amp;&amp; i &lt; limit; i++) &#123;</span><br><span class="line">    <span class="type">pte_t</span> *pte_ptr;</span><br><span class="line">    pte_ptr = walk(pagetable, firstpte + i * (uint64)PGSIZE, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ((pte_ptr != <span class="number">0</span>) &amp;&amp; (*pte_ptr &amp; PTE_A)) &#123;</span><br><span class="line">        mask = mask | (<span class="number">1L</span> &lt;&lt; i);</span><br><span class="line">        *pte_ptr = *pte_ptr &amp; (~PTE_A);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  copyout(pagetable, buf, (<span class="type">char</span> *)&amp;mask, <span class="number">8</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Optional-challenge-exercises-2">Optional challenge exercises</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>Use super-pages to reduce the number of PTEs in page tables.</p>
</li>
<li class="lvl-2">
<p>Unmap the first page of a user process so that dereferencing a null pointer will result in a fault. You will have to start the user text segment at, for example, 4096, instead of 0.</p>
</li>
<li class="lvl-2">
<p>Add a system call that reports dirty pages (modified pages) using PTE_D.</p>
</li>
</ul>
<link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script></article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/C/">C</a><a class="post-meta__tags" href="/tags/OS/">OS</a><a class="post-meta__tags" href="/tags/RISC-V/">RISC-V</a><a class="post-meta__tags" href="/tags/GNU-Make/">GNU Make</a></div><div class="post-share"><div class="social-share" data-image="/image/sheep.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2023/04/06/Manim/" title="Manim"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Manim</div></div><div class="info-2"><div class="info-item-1">Introduction Manim是数学视频博主3b1b开发并使用的Python图形引擎，用于制作数学科普视频。  Usage 基本框架 python12345from manimlib import *import numpy as npclass SceneName(Scene):    def construct(self): </div></div></div></a><a class="pagination-related" href="/2023/04/04/6-S081-Lecture-7/" title="MIT 6.S081 Lecture 7: Page faults"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">MIT 6.S081 Lecture 7: Page faults</div></div><div class="info-2"><div class="info-item-1">Reading  Read 4.6   Implenment VM features using page fault   lazy allocation   copy on write fork   demand paging   memory mapped files   Virtual Memory benefits   Isolation   level of indirection  trampline page guard page    Information needed   the faulting VA -&gt; stval register   type pf fault -&gt; scause register  load store pc    the VA of Instruction that cause fault -&gt; sepc register | trampframe?   lazy allocation   sbrk()原本应为进程改变堆的大小，分配内存    sbrk()系统调用基本不做事情，只p-&gt;size + n   ...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2023/05/03/6-S081-Lab-thread/" title="MIT 6.S081 Lab thread"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-03</div><div class="info-item-2">MIT 6.S081 Lab thread</div></div><div class="info-2"><div class="info-item-1">Compulsory exercises Preparation  reading  To start the lab, switch to the thread branch:  123git fetchgit checkout threadmake clean  Uthread: switching between threads (moderate) Using threads (moderate) Barrier(moderate) Optional challenge exercises The user-level thread package interacts badly with the operating system in several ways. For example, if one user-level thread blocks in a system call, another user-level thread won’t run, because the user-level threads scheduler doesn’t know th...</div></div></div></a><a class="pagination-related" href="/2023/04/28/6-S081-Lecture-17/" title="MIT 6.S081 Lecture 17: Virtual memory for applications"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-28</div><div class="info-item-2">MIT 6.S081 Lecture 17: Virtual memory for applications</div></div><div class="info-2"><div class="info-item-1">Reading  Read Virtual Memory Primitives for User Programs (1991)   </div></div></div></a><a class="pagination-related" href="/2023/04/23/6-S081-Lab-cow/" title="MIT 6.S081 Lab cow"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-23</div><div class="info-item-2">MIT 6.S081 Lab cow</div></div><div class="info-2"><div class="info-item-1">Compulsory exercises Preparation  To start the lab, switch to the cow branch:  123git fetchgit checkout cowmake clean  OS真不是人写的把😭   Implement copy-on write(hard)  当xv6 fork一个子进程时，需要复制父进程的地址空间，这不仅占用了空间，也消耗了时间，你的任务是采用写时复制，fork()时child使用parent的内存空间，即子进程映射到父进程的物理空间上，当进程要写时，触发Page Fault 实现COW  修改uvmcopy()以在fork()时不分配新page，而映射到父进程  vm.c uvmcopy()1234567891011121314151617181920212223242526272829303132intuvmcopy(pagetable_t old, pagetable_t new, uint64 sz)&#123;  pte_t *pte;  uint64 pa, i;  uint fla...</div></div></div></a><a class="pagination-related" href="/2023/04/22/6-S081-Lecture-16/" title="MIT 6.S081 Lecture 16: File system performance and fast crash recovery"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-22</div><div class="info-item-2">MIT 6.S081 Lecture 16: File system performance and fast crash recovery</div></div><div class="info-2"><div class="info-item-1">Reading  Read Journaling the Linux ext2fs Filesystem (1998)  Information   第一节OS论文的阅读讲座    ext3   “log” = journal   ext3 = ext2 + journal   xv6 log review ext3 log ext3 log format ASYNC Batching Concurrency ext3 code steps in commit </div></div></div></a><a class="pagination-related" href="/2023/04/22/6-S081-Lecture-15/" title="MIT 6.S081 Lecture 15: Crash recovery"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-22</div><div class="info-item-2">MIT 6.S081 Lecture 15: Crash recovery</div></div><div class="info-2"><div class="info-item-1">Reading  Read logging sections of “File system” read code   Information   最后一节关于xv6的讲座了，后面的重点会放在操作系统论文的阅读上   再见了所有的xv6 😭    Problem   crash如电源中断，系统重启等   crash会使得建立在磁盘上的文件系统进入不正确的的状态，怎样保证crash后维持正确的状态呢？   解决方案是logging   Risk   文件系统的操作是多步的   如果crash后重启，很可能要么再次crash，要么读写了错误的数据   logging   log的步骤   log writes commit op install clean log log能够保证文件系统操作的原子性，并提供快速恢复的能力，在不同步骤crash都有不同的恢复方案    log的内容   内存中有磁盘中log的cache    Challenges   eviction  不要驱逐正在log的block    fs operation must fit log  log限制了文件系统一...</div></div></div></a><a class="pagination-related" href="/2023/04/20/6-S081-Lecture-14/" title="MIT 6.S081 Lecture 14: File systems"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-20</div><div class="info-item-2">MIT 6.S081 Lecture 14: File systems</div></div><div class="info-2"><div class="info-item-1">Reading  Read Chapter8 read code    File System   User-friendly names/pathnames   Share files between users/process   Persistence/durability   Why intersting?   Abstraction is useful   Crash safety   Disk layout   Performance -&gt; Storage devices are slow -&gt; to be fast  storage -&gt; buffercache device -&gt; concurrency    API example    xv6文件系统提供的API实现了文件系统基本的用户级操作   FS structure    inode含有文件的信息，代表一个独立的文件   inode的大小是64Bytes   FS Layer    文件系统的多层结构抽象了硬件，并为软件提供了接口   Storage devices    这里需要...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/image/sheep.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Huayi</div><div class="author-info-description">Time to Code.</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">93</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">38</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">18</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/huaeryi"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">🚧施工中...</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Compulsory-exercises-2"><span class="toc-number">1.</span> <span class="toc-text">Compulsory exercises</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Preparation-2"><span class="toc-number">1.1.</span> <span class="toc-text">Preparation</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Speed-up-system-calls-easy"><span class="toc-number">1.2.</span> <span class="toc-text">Speed up system calls (easy)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Print-a-page-table-easy"><span class="toc-number">1.3.</span> <span class="toc-text">Print a page table (easy)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Detecting-which-pages-have-been-accessed-hard"><span class="toc-number">1.4.</span> <span class="toc-text">Detecting which pages have been accessed (hard)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Optional-challenge-exercises-2"><span class="toc-number">2.</span> <span class="toc-text">Optional challenge exercises</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/08/20/AtCoder-Beginner-Contest-419/" title="AtCoder Beginner Contest 419">AtCoder Beginner Contest 419</a><time datetime="2025-08-19T18:27:05.000Z" title="发表于 2025-08-20 02:27:05">2025-08-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/11/13/CSAPP-bomblab/" title="CSAPP bomblab">CSAPP bomblab</a><time datetime="2023-11-13T13:54:06.000Z" title="发表于 2023-11-13 21:54:06">2023-11-13</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/11/11/CSAPP-datalab/" title="CSAPP datalab">CSAPP datalab</a><time datetime="2023-11-11T05:46:54.000Z" title="发表于 2023-11-11 13:46:54">2023-11-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/11/08/Latex/" title="Latex">Latex</a><time datetime="2023-11-08T04:39:59.000Z" title="发表于 2023-11-08 12:39:59">2023-11-08</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/11/04/hackergame2023/" title="Hackergame2023">Hackergame2023</a><time datetime="2023-11-04T12:01:38.000Z" title="发表于 2023-11-04 20:01:38">2023-11-04</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2022 - 2025 By Huayi</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 6.1.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.4.3</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  const loadMathjax = () => {
    if (!window.MathJax) {
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          tags: 'none',
        },
        chtml: {
          scale: 1.1
        },
        options: {
          enableMenu: true,
          renderActions: {
            findScript: [10, doc => {
              for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
                const display = !!node.type.match(/; *mode=display/)
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
                const text = document.createTextNode('')
                node.parentNode.replaceChild(text, node)
                math.start = {node: text, delim: '', n: 0}
                math.end = {node: text, delim: '', n: 0}
                doc.math.push(math)
              }
            }, '']
          }
        }
      }

      const script = document.createElement('script')
      script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
      script.id = 'MathJax-script'
      script.async = true
      document.head.appendChild(script)
    } else {
      MathJax.startup.document.state(0)
      MathJax.texReset()
      MathJax.typesetPromise()
    }
  }

  btf.addGlobalFn('encrypt', loadMathjax, 'mathjax')
  window.pjax ? loadMathjax() : window.addEventListener('load', loadMathjax)
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>